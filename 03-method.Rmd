# Methods

We describe our methods in this chapter.
install all necessary libraries
```{r}
library(opentripplanner)            # Load Package
library(tidyr)
library(tmap)
library(RcppSimdJson)
library(tidyverse)
library(tigris)
library(sf)
library(leaflet)
library(here)
library(rgdal)
library(proj4)
```


Begin by collecting the block group data data and converting it to lat and lon
```{r}

#download data from the census website
bgcentroid <- read.csv("C:/Users/stuck/Documents/Transpo Research/Grocery Stores/For GIS/Block Group Centroid.csv", stringsAsFactors=F)

lat <- bgcentroid[["LATITUDE"]]
lon <- bgcentroid[["LONGITUDE"]]

```

Then, we collect data for grocery stores and convert that data to lat and lon. This data comes from ArcGIS
```{r}

```

We have a collection of park polygons, and in order to accurately measure the distance to the parks we need points along the border of the park.
```{r}
parks <- read_sf("C:/Users/stuck/Documents/Transpo Research/Parks/manual_edits_parks(final).geojson")


#get park boundary polygon
park_boundaries <- parks %>%
  ungroup() %>%
  select(id) %>%
  st_simplify(dTolerance = 100, preserveTopology = TRUE) %>%
  st_cast("MULTIPOLYGON") %>%
  st_cast("POLYGON") %>%
  st_cast("LINESTRING", group_or_split = TRUE)
point_samples <- park_boundaries %>%
  st_line_sample(density = 1/500)
park_points <- st_sf(id = 
                       park_boundaries$id, geometry = point_samples) %>%
  st_as_sf() %>%
  st_cast(to = "POINT")
```
We then need to covert these park point features into lat-lon coordinates

```{r}

```
After we have all the different lat-lon coordinates we can use the open trip planner server to discover routes and travel times from one location to another. This code is currently a tutorial code with London locations and data. 

```{r}
path_data <- file.path("C:/Users/Public", "OTP")
dir.create(path_data)

path_otp <- otp_dl_jar(path_data, cache = FALSE)

otp_dl_demo(path_data)

log1 <- otp_build_graph(otp = path_otp, dir =  path_data)

log2 <- otp_setup(otp = path_otp, dir = path_data)

otpcon <- otp_connect(timezone = "Europe/London")

lsoa <- sf::st_read("https://github.com/ropensci/opentripplanner/releases/download/0.1/centroids.gpkg",
                    stringsAsFactors = FALSE)
head(lsoa)

toPlace   = lsoa[rep(seq(1, 10), times = nrow(lsoa)),]
fromPlace = lsoa[rep(seq(1, 10), each  = nrow(lsoa)),]

routes <- otp_plan(otpcon = otpcon,
                   fromPlace = fromPlace,
                   toPlace = toPlace,
                   fromID = fromPlace$geo_code,
                   toID = toPlace$geo_code,
                   mode = c("WALK","BUS"),
                   get_geometry = FALSE)
routes <- routes[,c("fromPlace","toPlace","duration")]
# Use the tidyr package to go from long to wide format
routes_matrix <- tidyr::pivot_wider(routes, 
                                    names_from = "toPlace", 
                                    values_from = "duration")
```

We can also import the library shapefile. We will need to also convert these points to lat-lon as well at some point. That code is also included.

```{r}
library_points <- st_read("C:/Users/stuck/Documents/Transpo Research/Libraries/Library_Points.geojson")

write_points_file <- function(points, file){
  points %>%
    st_transform(4326) %>%
    mutate(
      LATITUDE = st_coordinates(.)[,2],
      LONGITUDE = st_coordinates(.)[,1]
    ) %>%
    st_set_geometry(NULL) %>%
    write_csv(file)
}

library_latlon <- library_points %>% write_points_file("points.csv")
```

